<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foro | Serenity</title>
  <link rel="stylesheet" href="../CSS/Foro/Foro.css">
  
</head>
<body>
  <header class="chat-header">
    <a href="Select.html" class="back-btn">← Volver</a>
    <div class="header-content">
      <img src="../assets/img/Select/Iconos/logo2.0.webp" alt="Serenity Logo" class="header-logo">
      <h1>Foro Serenity</h1>
    </div>
  </header>

  <main class="app-layout">
    <aside class="sidebar-left">
      <div class="server-header">
        <h2>Serenity</h2>
      </div>
      <div class="resources">
        <h3>Recursos</h3>
        <a href="Equipo.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/Equipo.png" alt="Equipo" class="resource-icon"> Equipo
        </a>
        <a href="information.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/informacion.png" alt="Información" class="resource-icon"> Información
        </a>
        <a href="Terminos.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/terminos.png" alt="Términos" class="resource-icon"> Términos de Uso
        </a>
        <a href="Select.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/Minijuegos.png" alt="Minijuegos" class="resource-icon"> Minijuegos
        </a>
      </div>
    </aside>

    <div class="chat-main">
      <div class="chat-messages" id="messages" aria-live="polite" aria-relevant="additions">
        
      </div>

      <form id="composer" class="chat-input" autocomplete="off">
        <input id="message" name="message" maxlength="500" placeholder="Escribe tu mensaje..." required />
        <button type="submit" aria-label="Enviar mensaje">Enviar</button>
      </form>
    </div>

    <aside class="sidebar-right">
      <div class="registered-users">
        <h3>Usuarios Registrados — <span id="userCount">0</span></h3>
        <div id="usersList">
       
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const elMessages = document.getElementById('messages');
      const elComposer = document.getElementById('composer');
      const elMessage = document.getElementById('message');
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');

      function escapeHtml(s){
        return (s || '').replace(/[&<>"]/g, c => ({'&':'&','<':'<','>':'>','"':'"'}[c]));
      }

      async function loadPosts(){
        try {
          const response = await fetch('http://127.0.0.1:8000/api/forum/posts');
          const data = await response.json();
          return data.posts || [];
        } catch (error) {
          console.error('Error loading posts:', error);
          return [];
        }
      }

      async function loadUsers(){
        try {
          const response = await fetch('http://127.0.0.1:8000/api/users');
          const data = await response.json();
          return data.users || [];
        } catch (error) {
          console.error('Error loading users:', error);
          return [];
        }
      }

      function renderUsers(users){
        const usersList = document.getElementById('usersList');
        const userCount = document.getElementById('userCount');
        userCount.textContent = users.length;
        usersList.innerHTML = '';

        users.forEach(user => {
          const userEl = document.createElement('div');
          userEl.className = 'user';
          userEl.style.cursor = 'pointer';
          userEl.onclick = () => {
            window.location.href = `Perfil/perfil-publico.html?id=${user.id}`;
          };

          const avatarSrc = user.profile_image || `https://api.dicebear.com/7.x/thumbs/svg?seed=${user.username}&backgroundColor=b6a6f2,ffc6d9&shapeColor=ffffff`;
          userEl.innerHTML = `
            <div class="user-avatar"><img src="${avatarSrc}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"></div>
            <span>${escapeHtml(user.username)}</span>
          `;
          usersList.appendChild(userEl);
        });
      }

      function render(posts){
        elMessages.innerHTML = '';
        posts.forEach((post, index) => {
          const msgEl = document.createElement('div');
          msgEl.className = 'message';
          msgEl.style.animationDelay = `${index * 0.05}s`;
          const avatarSrc = post.users?.profile_image || `https://api.dicebear.com/7.x/thumbs/svg?seed=${post.users?.username || 'Usuario'}&backgroundColor=b6a6f2,ffc6d9&shapeColor=ffffff`;
          msgEl.innerHTML = `
            <div class="message-avatar"><img src="${avatarSrc}" alt="Avatar"></div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">${escapeHtml(post.users?.username || 'Usuario')}</span>
                <span class="message-time">${new Date(post.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
              </div>
              <div class="message-text">${escapeHtml(post.message)}</div>
            </div>
          `;
          elMessages.appendChild(msgEl);
        });
        elMessages.scrollTop = elMessages.scrollHeight;
      }

      async function loadAndRender(){
        const posts = await loadPosts();
        render(posts);

        const users = await loadUsers();
        renderUsers(users);
      }

      elComposer.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = elMessage.value.trim();
        if (!text || !token) return;

        try {
          const response = await fetch('http://127.0.0.1:8000/api/forum/posts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message: text })
          });

          if (response.ok) {
            elMessage.value = '';
            loadAndRender();
          } else {
            alert('Error al enviar mensaje');
          }
        } catch (error) {
          console.error('Error posting:', error);
          alert('Error de conexión');
        }
      });

      
      loadAndRender();
    })();
  </script>
</body>
</html>